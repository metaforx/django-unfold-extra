{"version":3,"file":"theme-sync.js","sources":["../../../src/js/utils/theme-utils.js","../../../src/js/theme-sync.js"],"sourcesContent":["export const KEY_UNFOLD = 'adminTheme'; // JSON-encoded: \"light\" | \"dark\" | \"auto\"\nexport const KEY_CMS = 'theme';\n\nexport function applyTheme(theme) {\n    if (!theme) return;\n    console.log('applyTheme', theme);\n    let normalizedTheme = theme;\n    if (normalizedTheme && normalizedTheme[0] === '\"') {\n        try {\n            normalizedTheme = JSON.parse(normalizedTheme);\n        } catch {\n        }\n    }\n    if (!['light', 'dark', 'auto'].includes(normalizedTheme)) return;\n\n    const html = document.documentElement;\n    html.setAttribute('data-theme', normalizedTheme);\n    html.classList.remove('dark');\n\n    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;\n    const isDark = (normalizedTheme === 'dark') || (normalizedTheme === 'auto' && prefersDark);\n    if (isDark) html.classList.add('dark');\n}\n\nexport function readTheme() {\n    try {\n        const theme_unfold = localStorage.getItem(KEY_UNFOLD);\n        if (theme_unfold != null) return JSON.parse(theme_unfold);\n    } catch {\n    }\n    // }\n    // try {\n    //     const theme_cms = localStorage.getItem(KEY_CMS);\n    //     if (theme_cms != null) return JSON.parse(theme_cms);\n    // } catch {\n    // }\n    return null;\n}","import {KEY_CMS, KEY_UNFOLD, applyTheme} from './utils/theme-utils.js';\n\nlet mirroring = false;\n\napplyTheme(localStorage.getItem(KEY_UNFOLD))\n\nconst normalize = (val) => {\n    if (val == null) return null;\n    if (val[0] === '\"') {\n        try {\n            return JSON.parse(val);\n        } catch {\n        }\n    }\n    return val;\n};\n\nconst valid = (t) => t === 'light' || t === 'dark' || t === 'auto';\n\nwindow.addEventListener('storage', (e) => {\n    if (e.key !== KEY_UNFOLD && e.key !== KEY_CMS) return;\n    if (mirroring) return; // ignore events caused by our own mirror write\n\n    const raw = typeof e.newValue === 'string' ? e.newValue : null;\n    const theme = normalize(raw);\n    if (!valid(theme)) return;\n\n    try {\n        mirroring = true;\n\n        if (e.key === KEY_UNFOLD) {\n            // mirror to CMS as plain string if different\n            const current = localStorage.getItem(KEY_CMS);\n            if (current !== theme) localStorage.setItem(KEY_CMS, theme);\n        } else {\n            // mirror to UNFOLD as JSON string if different\n            const current = localStorage.getItem(KEY_UNFOLD);\n            const target = JSON.stringify(theme);\n            if (current !== target) localStorage.setItem(KEY_UNFOLD, target);\n        }\n    } finally {\n        mirroring = false;\n    }\n\n    applyTheme(theme);\n});"],"names":["KEY_UNFOLD","KEY_CMS","applyTheme","theme","normalizedTheme","e","html","prefersDark","mirroring","normalize","val","valid","t","raw","current","target"],"mappings":"yBAAO,MAAMA,EAAa,aACbC,EAAU,QAEhB,SAASC,EAAWC,EAAO,CAC9B,GAAI,CAACA,EAAO,OACZ,QAAQ,IAAI,aAAcA,CAAK,EAC/B,IAAIC,EAAkBD,EACtB,GAAIC,GAAmBA,EAAgB,CAAC,IAAM,IAC1C,GAAI,CACAA,EAAkB,KAAK,MAAMA,CAAe,CAChD,OAAQC,EAAA,CACR,CAEJ,GAAI,CAAC,CAAC,QAAS,OAAQ,MAAM,EAAE,SAASD,CAAe,EAAG,OAE1D,MAAME,EAAO,SAAS,gBACtBA,EAAK,aAAa,aAAcF,CAAe,EAC/CE,EAAK,UAAU,OAAO,MAAM,EAE5B,MAAMC,EAAc,OAAO,YAAc,OAAO,WAAW,8BAA8B,EAAE,SAC3EH,IAAoB,QAAYA,IAAoB,QAAUG,IAClED,EAAK,UAAU,IAAI,MAAM,CACzC,CCpBA,IAAIE,EAAY,GAEhBN,EAAW,aAAa,QAAQF,CAAU,CAAC,EAE3C,MAAMS,EAAaC,GAAQ,CACvB,GAAIA,GAAO,KAAM,OAAO,KACxB,GAAIA,EAAI,CAAC,IAAM,IACX,GAAI,CACA,OAAO,KAAK,MAAMA,CAAG,CACzB,OAAQL,EAAA,CACR,CAEJ,OAAOK,CACX,EAEMC,EAASC,GAAMA,IAAM,SAAWA,IAAM,QAAUA,IAAM,OAE5D,OAAO,iBAAiB,UAAY,GAAM,CAEtC,GADI,EAAE,MAAQZ,GAAc,EAAE,MAAQC,GAClCO,EAAW,OAEf,MAAMK,EAAM,OAAO,EAAE,UAAa,SAAW,EAAE,SAAW,KACpDV,EAAQM,EAAUI,CAAG,EAC3B,GAAKF,EAAMR,CAAK,EAEhB,IAAI,CAGA,GAFAK,EAAY,GAER,EAAE,MAAQR,EAEM,aAAa,QAAQC,CAAO,IAC5BE,GAAO,aAAa,QAAQF,EAASE,CAAK,MACvD,CAEH,MAAMW,EAAU,aAAa,QAAQd,CAAU,EACzCe,EAAS,KAAK,UAAUZ,CAAK,EAC/BW,IAAYC,GAAQ,aAAa,QAAQf,EAAYe,CAAM,CACnE,CACJ,QAAC,CACGP,EAAY,EAChB,CAEAN,EAAWC,CAAK,EACpB,CAAC"}